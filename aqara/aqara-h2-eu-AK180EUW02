blueprint:
  name: Aqara H2 EU Switch – uitgebreid (knop 4 & 5, optioneel)
  description: >
    Uitgebreid blueprint voor Aqara H2 EU switch via Matter.
    Ondersteunt knop 4 en 5 met initial_press events.
    Knoppen zijn optioneel.
    Optioneel ander gedrag tijdens nachturen.
  domain: automation

  input:
    button_4:
      name: Knop 4 (event, optioneel)
      description: Event entiteit van knop 4 (alleen Aqara Matter)
      default: ""
      selector:
        entity:
          domain: event
          integration: matter

    button_4_action:
      name: Actie knop 4 (overdag)
      default: []
      selector:
        action: {}

    button_4_night_action:
      name: Actie knop 4 (nacht, optioneel)
      default: []
      selector:
        action: {}

    button_5:
      name: Knop 5 (event, optioneel)
      description: Event entiteit van knop 5 (alleen Aqara Matter)
      default: ""
      selector:
        entity:
          domain: event
          integration: matter

    button_5_action:
      name: Actie knop 5 (overdag)
      default: []
      selector:
        action: {}

    button_5_night_action:
      name: Actie knop 5 (nacht, optioneel)
      default: []
      selector:
        action: {}

    night_start:
      name: Nacht begint om
      default: "23:00:00"
      selector:
        time: {}

    night_end:
      name: Nacht eindigt om
      default: "06:00:00"
      selector:
        time: {}

mode: restart

trigger: []

# ───────── Variabelen ─────────
variables:
  is_night: >
    {% set start = strptime(night_start, '%H:%M:%S').time() %}
    {% set end = strptime(night_end, '%H:%M:%S').time() %}
    {% set now = now().time() %}
    {% if start < end %}
      {{ start <= now < end }}
    {% else %}
      {{ now >= start or now < end }}
    {% endif %}

# ───────── Acties ─────────
action:
  - choose:
      # ───────── Knop 4 ─────────
      - conditions:
          - condition: template
            value_template: "{{ button_4 != '' and trigger.entity_id == button_4 and trigger.to_state.state == 'initial_press' }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ is_night and button_4_night_action | length > 0 }}"
                sequence: !input button_4_night_action
            default: !input button_4_action

      # ───────── Knop 5 ─────────
      - conditions:
          - condition: template
            value_template: "{{ button_5 != '' and trigger.entity_id == button_5 and trigger.to_state.state == 'initial_press' }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ is_night and button_5_night_action | length > 0 }}"
                sequence: !input button_5_night_action
            default: !input button_5_action
